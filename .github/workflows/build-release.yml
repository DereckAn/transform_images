name: Build and Release

on:
  push:
    branches: [main, test-workflow]
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  APP_NAME: QuakImages

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libraw-dev \
            liblcms2-dev \
            libjpeg-dev

      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: rust-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            rust-${{ runner.os }}-

      - name: Run tests
        run: cd src-tauri && cargo test --lib --verbose

  build-frontend:
    name: Build Frontend Bundle
    needs: test
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-frontend.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute frontend hash
        id: frontend-hash
        run: |
          HASH=$(git ls-files \
            'src/**' \
            'package.json' \
            'bun.lock' \
            'svelte.config.js' \
            'vite.config.ts' \
            'tsconfig.json' | sort | xargs sha256sum | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Restore cached build
        id: cache-frontend
        uses: actions/cache@v4
        with:
          path: dist
          key: svelte-build-${{ steps.frontend-hash.outputs.hash }}
          restore-keys: |
            svelte-build-

      - name: Setup Bun
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: bun install --frozen-lockfile

      - name: Build frontend
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: bun run build

      - name: Verify dist folder exists
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist folder not found!"
            exit 1
          fi
          echo "âœ… dist folder found with $(find dist -type f | wc -l) files"
          ls -la dist/

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist
          retention-days: 3

  build-tauri:
    name: Build (${{ matrix.name }})
    needs: [test, build-frontend]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS-Intel
            platform: macos-15-intel
            target: x86_64-apple-darwin
          - name: macOS-AppleSilicon
            platform: macos-latest
            target: aarch64-apple-darwin
          - name: Windows-x64
            platform: windows-latest
            target: x86_64-pc-windows-msvc
          - name: Windows-ARM64
            platform: windows-11-arm
            target: aarch64-pc-windows-msvc
          - name: Linux-x64
            platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - name: Linux-ARM64
            platform: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Download frontend bundle
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: dist

      - name: Setup Bun (standard)
        if: matrix.platform != 'windows-11-arm'
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Try install Bun (Windows ARM64)
        if: matrix.platform == 'windows-11-arm'
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "Intentando instalar Bun para Windows ARM64..."
          try {
            irm bun.sh/install.ps1 | iex
            bun --version
            Write-Host "âœ… Bun instalado correctamente"
            echo "BUN_AVAILABLE=true" >> $env:GITHUB_ENV
          } catch {
            Write-Host "âš ï¸ Bun no disponible, usando npm como fallback"
            echo "BUN_AVAILABLE=false" >> $env:GITHUB_ENV
          }

      - name: Setup Node.js (fallback)
        if: matrix.platform == 'windows-11-arm' && env.BUN_AVAILABLE != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: brew install libraw little-cms2 jpeg-turbo

      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat

          # Detectar arquitectura y usar el triplet correcto
          $arch = if ($env:PROCESSOR_ARCHITECTURE -eq "ARM64") { "arm64" } else { "x64" }
          C:\vcpkg\vcpkg install libraw:${arch}-windows-static lcms:${arch}-windows-static libjpeg-turbo:${arch}-windows-static zlib:${arch}-windows-static
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev libgtk-3-dev build-essential curl wget file \
            libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev \
            libraw-dev liblcms2-dev libjpeg-dev

      - name: Cache Rust
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: rust-${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            rust-${{ runner.os }}-${{ matrix.target }}-

      - name: Cache Bun
        if: matrix.platform != 'windows-11-arm' || env.BUN_AVAILABLE == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: bun-${{ runner.os }}-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            bun-${{ runner.os }}-

      - name: Cache npm
        if: matrix.platform == 'windows-11-arm' && env.BUN_AVAILABLE != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: npm-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Install dependencies (Bun)
        if: matrix.platform != 'windows-11-arm' || env.BUN_AVAILABLE == 'true'
        run: bun install --frozen-lockfile

      - name: Install dependencies (npm)
        if: matrix.platform == 'windows-11-arm' && env.BUN_AVAILABLE != 'true'
        run: npm ci

      - name: Build Tauri app (Bun)
        if: matrix.platform != 'windows-11-arm' || env.BUN_AVAILABLE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_SKIP_BUILD_FRONTEND: "true"
        run: bun run tauri build --features static

      - name: Build Tauri app (npm)
        if: matrix.platform == 'windows-11-arm' && env.BUN_AVAILABLE != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_SKIP_BUILD_FRONTEND: "true"
        run: npm run tauri build -- --features static

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-${{ matrix.target }}
          path: src-tauri/target/${{ matrix.target }}/release/bundle/**
          retention-days: 7

  release:
    name: Create Release
    needs: build-tauri
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        id: prepare
        run: |
          mkdir -p release-assets
          VERSION=$(jq -r '.version' src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          APP="${{ env.APP_NAME }}"

          copy_file() {
            local target="$1" pattern="$2" dest="$3"
            local file=$(find "artifacts/tauri-${target}" -type f -name "$pattern" 2>/dev/null | head -1)
            if [ -n "$file" ] && [ -f "$file" ]; then
              cp "$file" "release-assets/${dest}"
              echo "âœ… ${dest}"
            else
              echo "âš ï¸ No encontrado: $pattern en tauri-${target}"
            fi
          }

          # macOS Intel
          copy_file "x86_64-apple-darwin" "*.dmg" "${APP}-${VERSION}-macOS-Intel.dmg"
          copy_file "x86_64-apple-darwin" "*.app.tar.gz" "${APP}-${VERSION}-macOS-Intel.app.tar.gz"
          copy_file "x86_64-apple-darwin" "*.app.tar.gz.sig" "${APP}-${VERSION}-macOS-Intel.app.tar.gz.sig"

          # macOS Apple Silicon
          copy_file "aarch64-apple-darwin" "*.dmg" "${APP}-${VERSION}-macOS-AppleSilicon.dmg"
          copy_file "aarch64-apple-darwin" "*.app.tar.gz" "${APP}-${VERSION}-macOS-AppleSilicon.app.tar.gz"
          copy_file "aarch64-apple-darwin" "*.app.tar.gz.sig" "${APP}-${VERSION}-macOS-AppleSilicon.app.tar.gz.sig"

          # Windows x64 (NSIS - recomendado para updater)
          copy_file "x86_64-pc-windows-msvc" "*x64-setup.exe" "${APP}-${VERSION}-Windows-x64-Setup.exe"
          copy_file "x86_64-pc-windows-msvc" "*x64-setup.exe.sig" "${APP}-${VERSION}-Windows-x64-Setup.exe.sig"
          # Windows x64 MSI (opcional, solo si se compila en Windows)
          copy_file "x86_64-pc-windows-msvc" "*x64_en-US.msi" "${APP}-${VERSION}-Windows-x64.msi"

          # Windows ARM64 (NSIS)
          copy_file "aarch64-pc-windows-msvc" "*arm64-setup.exe" "${APP}-${VERSION}-Windows-ARM64-Setup.exe"
          copy_file "aarch64-pc-windows-msvc" "*arm64-setup.exe.sig" "${APP}-${VERSION}-Windows-ARM64-Setup.exe.sig"
          # Windows ARM64 MSI (opcional)
          copy_file "aarch64-pc-windows-msvc" "*arm64_en-US.msi" "${APP}-${VERSION}-Windows-ARM64.msi"

          # Linux x64 (NO genera .sig - updater no soportado)
          copy_file "x86_64-unknown-linux-gnu" "*.AppImage" "${APP}-${VERSION}-Linux-x64.AppImage"
          copy_file "x86_64-unknown-linux-gnu" "*.deb" "${APP}-${VERSION}-Linux-x64.deb"
          copy_file "x86_64-unknown-linux-gnu" "*.rpm" "${APP}-${VERSION}-Linux-x64.rpm"

          # Linux ARM64 (NO genera .sig - updater no soportado)
          copy_file "aarch64-unknown-linux-gnu" "*.AppImage" "${APP}-${VERSION}-Linux-ARM64.AppImage"
          copy_file "aarch64-unknown-linux-gnu" "*.deb" "${APP}-${VERSION}-Linux-ARM64.deb"
          copy_file "aarch64-unknown-linux-gnu" "*.rpm" "${APP}-${VERSION}-Linux-ARM64.rpm"

          # Generar checksums SHA256 para verificaciÃ³n de integridad
          (cd release-assets && sha256sum * > SHA256SUMS 2>/dev/null || true)

      - name: Generate latest.json
        run: |
          VERSION=${{ steps.prepare.outputs.version }}
          TAG=${GITHUB_REF#refs/tags/}
          REPO=${{ github.repository }}
          APP="${{ env.APP_NAME }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          read_sig() {
            local file="release-assets/$1"
            [ -f "$file" ] && cat "$file" || echo ""
          }

          MACOS_INTEL_SIG=$(read_sig "${APP}-${VERSION}-macOS-Intel.app.tar.gz.sig")
          MACOS_ARM_SIG=$(read_sig "${APP}-${VERSION}-macOS-AppleSilicon.app.tar.gz.sig")
          WINDOWS_X64_SIG=$(read_sig "${APP}-${VERSION}-Windows-x64-Setup.exe.sig")
          WINDOWS_ARM_SIG=$(read_sig "${APP}-${VERSION}-Windows-ARM64-Setup.exe.sig")

          cat > release-assets/latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See release notes on GitHub",
            "pub_date": "${PUB_DATE}",
            "platforms": {
              "darwin-x86_64": {
                "signature": "${MACOS_INTEL_SIG}",
                "url": "${BASE_URL}/${APP}-${VERSION}-macOS-Intel.app.tar.gz"
              },
              "darwin-aarch64": {
                "signature": "${MACOS_ARM_SIG}",
                "url": "${BASE_URL}/${APP}-${VERSION}-macOS-AppleSilicon.app.tar.gz"
              },
              "windows-x86_64": {
                "signature": "${WINDOWS_X64_SIG}",
                "url": "${BASE_URL}/${APP}-${VERSION}-Windows-x64-Setup.exe"
              },
              "windows-aarch64": {
                "signature": "${WINDOWS_ARM_SIG}",
                "url": "${BASE_URL}/${APP}-${VERSION}-Windows-ARM64-Setup.exe"
              }
            }
          }
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ ${{ env.APP_NAME }} ${{ github.ref_name }}

            Professional image transformation and optimization tool with RAW format support.

            ### Downloads

            | Platform | Architecture | Download |
            |----------|-------------|----------|
            | macOS | Intel | [.dmg](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-macOS-Intel.dmg) |
            | macOS | Apple Silicon | [.dmg](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-macOS-AppleSilicon.dmg) |
            | Windows | x64 | [Setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Windows-x64-Setup.exe) / [.msi](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Windows-x64.msi) |
            | Windows | ARM64 | [Setup.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Windows-ARM64-Setup.exe) / [.msi](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Windows-ARM64.msi) |
            | Linux | x64 | [.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-x64.AppImage) / [.deb](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-x64.deb) / [.rpm](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-x64.rpm) |
            | Linux | ARM64 | [.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-ARM64.AppImage) / [.deb](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-ARM64.deb) / [.rpm](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.APP_NAME }}-${{ steps.prepare.outputs.version }}-Linux-ARM64.rpm) |

            ### ğŸ”„ Auto-Update
            If you already have the app installed, it will automatically check for updates and notify you when a new version is available!

            **Supported platforms:** macOS (Intel & Apple Silicon), Windows (x64 & ARM64)

            **Note:** Linux users need to manually download and install updates.

            ### ğŸ macOS Installation Note
            If you see "app is damaged", run:
            ```bash
            sudo xattr -d com.apple.quarantine "/Applications/quakimages.app"
            ```
